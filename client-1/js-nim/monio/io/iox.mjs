/*! Monio: iox.mjs
    v0.34.0-pre (c) 2022 Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
import{EMPTY_FUNC,identity,isFunction,isPromise,isMonad,curry,getDeferred,continuation,runSignal,isRunSignal,trampoline}from"../lib/util.mjs";import Either from"../either.mjs";import IO from"./io.mjs";onEvent=curry(onEvent,2),onceEvent=curry(onceEvent,2),of.empty=ofEmpty;const BRAND={},EMPTY={},UNSET=Symbol("unset"),CLOSED=Symbol("closed");var registerHooks=new WeakMap;export default Object.assign(IOx,{of:of,pure:of,unit:of,is:is,do:$do,doEither:doEither,onEvent:onEvent,onceEvent:onceEvent,onTimer:onTimer,merge:merge,zip:zip,fromIO:fromIO,fromIter:fromIter,toIter:toIter});export{of};export{of as pure};export{of as unit};export{is};export{$do as do};export{doEither};export{onEvent};export{onceEvent};export{onTimer};export{merge};export{zip};export{fromIO};export{fromIter};export{toIter};function IOx(e,n=[]){n=Array.isArray(n)?[...n]:[n];var t,r,i,o=UNSET,s=UNSET,u=new WeakMap,c=new WeakMap,a=new WeakSet,l=new WeakSet,f=!1,p=!1,d=!1,g=!1,h=!1,m=0,y=IO((function effect(i){if(h)return[UNSET,CLOSED,EMPTY].includes(s)?getDeferred().pr:s;if(!g&&isFunction(e)){var c=continuation([]);return f||d||c.push((()=>function registerWithDeps(e){if(Array.isArray(n)&&n.length>0)return f=!0,registerDep(n);registrationComplete();function registerDep([n,...t]){var r=t.length>0?()=>registerDep(t):registrationComplete;if(is(n)&&registerHooks.has(n)&&!u.has(n)){u.set(n,[]);let[t]=registerHooks.get(n);if(isFunction(t))return continuation([()=>t(onDepUpdate,n,e),r])}return continuation([r,identity])}function registrationComplete(){f=!1,d=!0}}(i))),c.push((()=>p?identity:function execIOF(i){return checkDepsAndExecute(UNSET,!0);function checkDepsAndExecute(n,s){var u;if(p=!0,!g&&e&&(o=i,u=collectDepVals(i,s)),u){if(u===CLOSED||!e)try{return(n!==UNSET?n:void 0)||t||getDeferred().pr}finally{close(),p=!1}}else try{return n!==UNSET?n:(t||({pr:t,next:r}=getDeferred()),t)}finally{discardCurrentIODepVals(),p=!1}return continuation([()=>e(o,...u),e=>commitIOFResult(e,n)])}function commitIOFResult(e,t){if(!p)return e;if(!g&&e!==EMPTY)return continuation([()=>updateCurrentVal(e,function haveQueuedIOxDepVals(){if(haveDeps())for(let e of n)if(is(e)){let n=u.get(e);if(n&&n.length>1)return!0}return!1}()),settleUpdate]);try{return t!==UNSET?t:void 0}finally{discardCurrentIODepVals(),p=!1}}function settleUpdate(e){if(!isPromise(e)&&function haveIOxDeps(){if(haveDeps())return n.some(is)}())return function discardCurrentIOxDepVals(){if(haveDeps())for(let e of n)is(e)&&removeDepVal(e)}(),checkDepsAndExecute(e,!1);try{return function discardCurrentDepVals(){if(haveDeps())for(let e of n)removeDepVal(e),a.delete(e)}(),e}finally{discardCurrentIODepVals(),p=!1}}}(i))),1==c.length&&c.push(identity),c}if(![UNSET,CLOSED,EMPTY].includes(s))return s}));y.assign=assign;var E=Object.assign((function IOx$(e){assign(e)}),{map:function map(e){return IOx(((n,t)=>e(t)),[E])},chain:chain,flatMap:chain,bind:chain,concat:function concat(e){return IOx(((n,t)=>continuation([()=>e.run(runSignal(n)),e=>isPromise(e)?e.then((e=>t.concat(e))):t.concat(e)])),[E])},run:function run(e){if(!g)return isRunSignal(e)?y.run(e):trampoline(y.run(runSignal(e)))},stop:stop,close:close,isClosed:function isClosed(){return g},freeze:function freeze(){h=!0,stop()},isFrozen:function isFrozen(){return h},toString:function toString(){return`[function ${this[Symbol.toStringTag]||this.name}]`},_chain_with_IO:function _chain_with_IO(e){return s!==UNSET&&o!==UNSET?e(s!==CLOSED?s:void 0):y?y.chain(e):e(void 0)},_inspect:function _inspect(){return g?"IOx(-closed-)":`${E[Symbol.toStringTag]}(${isMonad(s)&&isFunction(s._inspect)?s._inspect():[UNSET,CLOSED].includes(s)?isFunction(e)?e.name||"anonymous function":"..":String(s)})`},_is:function _is(e){return!(e!==BRAND&&!(y||IO.of())._is(e))},[Symbol.toStringTag]:"IOx"});return registerHooks.set(E,[registerListener,function unregisterListener(e){if(Array.isArray(i)&&i.length>0){let n=i.findIndex((n=>n==e));-1!=n&&i.splice(n,1)}}]),E;function stop(){unregisterWithDeps(),o=UNSET}function close(o){if(!g){g=!0,stop();let s=continuation([()=>{try{return updateCurrentVal(CLOSED,!1)}finally{registerHooks.delete(E),a=l=t=r=n=e=y=E=i=null}},identity]);return isRunSignal(o)?s:trampoline(s)}}function assign(t){g||h||(unregisterWithDeps(),n=o=e=null,trampoline(updateCurrentVal(t,!1)))}function chain(e){return IOx((function IOxChain(n,t){var r=e(t);return isPromise(r)?r.then((e=>trampoline(handle(e)))):handle(r);function handle(e){var runCIOx=()=>e.run(runSignal(n));return registerHooks.has(e)?continuation([()=>registerListener(((n,t)=>{if(t===CLOSED&&e&&!e.isClosed())return e.close(runSignal())}),E,o!==UNSET?o:n),runCIOx]):runCIOx()}}),[E])}function haveDeps(){return Array.isArray(n)&&n.length>0}function discardCurrentIODepVals(){if(haveDeps())for(let e of n)IO.is(e)&&!is(e)&&removeDepVal(e)}function onDepUpdate(e,n){if(n===CLOSED?(l.add(e),c.delete(e)):setDepVal(e,n),!f&&!p){if(o!==UNSET&&n!==CLOSED)return safeIORun(E,runSignal(o));if(collectDepVals(void 0,!1)===CLOSED)return close(runSignal())}}function setDepVal(e,n){u.has(e)||u.set(e,[]),u.get(e).push(n),is(e)&&c.set(e,n)}function getDepVal(e){return hasDepVal(e)?u.get(e)[0]:void 0}function hasDepVal(e){return u.has(e)&&u.get(e).length>0}function removeDepVal(e){hasDepVal(e)&&u.get(e).shift()}function collectDepVals(e,t){if(!haveDeps())return[];if(++m>1)return!1;for(var r;m>0;){r=[];for(let e of n)if(is(e)&&(l.has(e)||e.isClosed())&&(!p||!hasDepVal(e)))return m=0,CLOSED;for(let i of n)if(is(i)){let e=hasDepVal(i)?getDepVal(i):t&&c.has(i)?c.get(i):UNSET;r.push(e)}else if(IO.is(i))if(a&&a.has(i))r.push(UNSET);else if(hasDepVal(i))r.push(getDepVal(i));else{let n=trampoline(i.run(runSignal(e||(o!==UNSET?o:void 0))));isPromise(n)?(a.add(i),r.push(UNSET),n.then((e=>{a&&a.has(i)&&(a.delete(i),trampoline(onDepUpdate(i,e)))})).catch(logUnhandledError)):(a.delete(i),setDepVal(i,n),r.push(n))}else i===EMPTY?r.push(UNSET):r.push(i);r.includes(UNSET)&&(r=!1),m=Math.max(0,m-1)}return Array.isArray(r)&&r.length>0?r:void 0}function updateCurrentVal(e,n){return isPromise(e)?e.then((e=>trampoline(handleValue(e)))).catch(logUnhandledError):(n=!1,handleValue(e));function handleValue(e){return s=e,Array.isArray(i)&&i.length>0?notifyListeners(E,s,i):checkIOxQueue()}function notifyListeners(e,n,[t,...r]){return continuation([()=>t(e,n),r.length>0?()=>notifyListeners(e,n,r):checkIOxQueue])}function checkIOxQueue(){return n&&!p&&o!==UNSET?continuation([()=>safeIORun(E,runSignal(o)),completeUpdate]):completeUpdate()}function completeUpdate(){return s===CLOSED&&y&&close(),[UNSET,CLOSED,EMPTY].includes(s)?r?(r(void 0),void(t=r=null)):void 0:(r&&(r(s),t=r=null),s)}}function registerListener(e,n,t){return s===CLOSED?e(n,CLOSED):(Array.isArray(i)?i.push(e):i=[e],o===UNSET?safeIORun(E,runSignal(t)):s!==UNSET?e(n,s):void 0)}function unregisterWithDeps(){if(d=!1,haveDeps()){for(let e of n)if(e&&isFunction(e)&&registerHooks.has(e)){u.delete(e),a&&a.delete(e);let[,n]=registerHooks.get(e);isFunction(n)&&n(onDepUpdate)}u=new WeakMap,c=new WeakMap}}}function is(e){return!!(e&&isFunction(e._is)&&e._is(BRAND))}function of(e){return IOx((()=>e),[])}function ofEmpty(){return IOx(EMPTY_FUNC,[EMPTY])}function $do(e,n,...t){return IOx(((n,...r)=>IO.do(e,...r,...t).run(n)),n)}function doEither(e,n,...t){return IOx(((n,...r)=>IO.doEither(e,...r,...t).run(n)),n)}function onEvent(e,n,t=!1){var r=!1,i=IOx((function effect(){return subscribe(),EMPTY}),[]),{run:o,stop:s,close:u}=i;return Object.assign(i,{run:run,stop:stop,close:function close(n){if(i){Object.assign(i,{run:o,stop:s,close:u}),stop();let r=continuation([()=>{try{return i.close(n)}finally{run=o=s=stop=u=i=e=t=null}},identity]);return isRunSignal(n)?r:trampoline(r)}}}),i;function subscribe(){!r&&i&&(r=!0,isFunction(e.addEventListener)?e.addEventListener(n,i,t):isFunction(e.addListener)?e.addListener(n,i):isFunction(e.on)&&e.on(n,i))}function run(e){if(o)return subscribe(),o(e)}function stop(){!function unsubscribe(){r&&i&&(r=!1,isFunction(e.removeEventListener)?e.removeEventListener(n,i,t):isFunction(e.removeListener)?e.removeListener(n,i):isFunction(e.off)&&e.off(n,i))}(),s()}}function onceEvent(e,n,t=!1){var r,i=!1,o=!1,s=onEvent(e,n,t),{run:u,stop:c,close:a}=s;return Object.assign(s,{run:run,stop:stop,close:close}),s;function run(e){if(s&&(u&&(s.run=u),function subscribe(){i||r||!s||(i=!0,r=IOx(onFire,[s]))}(),r))return r.run(e)}function stop(){s&&(s.run=run,function unsubscribe(){i&&r&&(i=!1,r.close(),r=null)}(),c())}function close(e){if(s){Object.assign(s,{run:u,stop:c,close:a}),stop();let n=continuation([()=>{try{return s.close(e)}finally{run=u=c=stop=a=close=s=r=null}},identity]);return isRunSignal(e)?n:trampoline(n)}}function onFire(){o||(o=!0,close())}}function onTimer(e,n){var t,r=!1,i=IOx((function effect(){return subscribe(),EMPTY}),[]);n="number"==typeof n?Math.max(1,n||1):void 0;var{run:o,stop:s,close:u}=i;return Object.assign(i,{run:run,stop:stop,close:close}),i;function subscribe(){r||t||(r=!0,t=setInterval(onTick,e))}function run(e){if(subscribe(),o)return o(e)}function onTick(){i&&i("tick"),"number"==typeof n&&(n--,close&&n<=0&&close())}function stop(){!function unsubscribe(){r&&t&&(r=!1,clearInterval(t),t=null)}(),s()}function close(e){if(i){Object.assign(i,{run:o,stop:s,close:u}),stop();let n=continuation([()=>{try{return i.close(e)}finally{run=o=s=stop=u=close=i=null}},identity]);return isRunSignal(e)?n:trampoline(n)}}}function zip(e=[]){Array.isArray(e)&&(e=[...e]);var n=!1,t=new Map,r=IOx((function effect(e){return continuation([()=>subscribe(e),()=>EMPTY])}),[]),{run:i,stop:o,close:s}=r;return Object.assign(r,{run:run,stop:stop,close:close}),r;function subscribe(t){if(!n&&r&&(n=!0,Array.isArray(e)&&e.length>0))return subscribeToIOxs(e,t)}function subscribeToIOxs([e,...n],r){return continuation([()=>{if(t.has(e)||t.set(e,[]),registerHooks.has(e)){let[n]=registerHooks.get(e);return n(onUpdate,e,r)}},n.length>0?()=>subscribeToIOxs(n,r):checkListeners])}function onUpdate(e,n){if(r&&!r.isClosed())return n!==CLOSED&&t.has(e)&&t.get(e).push(n),checkListeners()}function checkListeners(){if(r&&!r.isClosed()&&Array.isArray(e))for(;;){let n,i,o=!0;for(let r of e){r&&!r.isClosed()&&(o=!1);let e=t.get(r);if(e.length>0)i=i||[],n=n||[],i.push(e[0]),n.push(e);else if(r&&!r.isClosed())return}if(!(Array.isArray(i)&&Array.isArray(n)&&i.length>0&&n.length>0)){if(o)return close(runSignal());break}for(let e of n)e.shift();r(i)}}function run(e){if(i){let n=continuation([subscribe,()=>i(e)]);return isRunSignal(e)?n:trampoline(n)}}function stop(){!function unsubscribe(){if(n&&r&&(n=!1,Array.isArray(e)))for(let n of e)if(registerHooks.has(n)){let[,e]=registerHooks.get(n);e(onUpdate)}}(),o()}function close(n){if(r){Object.assign(r,{run:i,stop:o,close:s}),stop();let u=continuation([()=>{try{return r.close(n)}finally{run=i=o=stop=s=close=t=r=e=null}},identity]);return isRunSignal(n)?u:trampoline(u)}}}function merge(e=[]){Array.isArray(e)&&(e=[...e]);var n=!1,t=IOx((function effect(e){return continuation([()=>subscribe(e),()=>EMPTY])}),[]),{run:r,stop:i,close:o}=t;return Object.assign(t,{run:run,stop:stop,close:close}),t;function subscribe(r){if(!n&&t&&(n=!0,Array.isArray(e)&&e.length>0))return subscribeToIOxs(e,r)}function subscribeToIOxs([e,...n],t){return continuation([()=>{if(registerHooks.has(e)){let[n]=registerHooks.get(e);return n(onUpdate,e,t)}},n.length>0?()=>subscribeToIOxs(n,t):checkListeners])}function onUpdate(e,n){if(t&&!t.isClosed())return n!==CLOSED&&t(n),checkListeners()}function checkListeners(){if(t&&!t.isClosed()&&Array.isArray(e)&&e.every((e=>!e||e.isClosed())))return close(runSignal())}function run(e){if(r){let n=continuation([subscribe,()=>r(e)]);return isRunSignal(e)?n:trampoline(n)}}function stop(){!function unsubscribe(){if(n&&t&&(n=!1,Array.isArray(e)))for(let n of e)if(registerHooks.has(n)){let[,e]=registerHooks.get(n);e(onUpdate)}}(),i()}function close(n){if(t){Object.assign(t,{run:r,stop:i,close:o}),stop();let s=continuation([()=>{try{return t.close(n)}finally{run=r=i=stop=o=close=t=e=null}},identity]);return isRunSignal(n)?s:trampoline(s)}}}function fromIO(e){return IOx(skipFirstIdentity,[e])}function skipFirstIdentity(e,n){return n}function fromIter(e,n=!0){Symbol("paused");var t,r,i,o=!1,s=this,u=IOx((function effect(){return function subscribe(){!o&&u&&(o=!0,i=function getIter(e){return isFunction(e)?e.call(s):e&&isFunction(e.next)?e:e&&e[Symbol.iterator]?e[Symbol.iterator]():e&&e[Symbol.asyncIterator]?e[Symbol.asyncIterator]():void 0}(e),({pr:r,next:t}=getDeferred()),async function drainIterator(){var e=!0;try{for(;o;){let n=i.next();if(isPromise(n)&&(n=await Promise.race([r,n])),!n)break;if(n===CLOSED||!o||n.done)break;if(isPromise(n.value)){if(n=await Promise.race([r,n.value]),n===CLOSED||!e)break;u(n)}else u(n.value)}}finally{e=!1,n&&close?close():await unsubscribe()}}().catch(logUnhandledError))}(),EMPTY}),[]),{run:c,stop:a,close:l}=u;return Object.assign(u,{run:run,stop:stop,close:close}),u;function unsubscribe(){o&&u&&(t&&(t(CLOSED),r=t=null),o=!1)}function run(e){if(c)return c(e)}function stop(){unsubscribe(),a()}function close(e){if(u){Object.assign(u,{run:c,stop:a,close:l}),stop();let n=continuation([()=>{try{return u.close(e)}finally{run=c=a=stop=l=close=u=null}},identity]);return isRunSignal(e)?n:trampoline(n)}}}function toIter(e,n){var t,r=[],i=[],o=!1,s=!1,u={[Symbol.asyncIterator](){return this},next:doNext,return:doReturn};return u;function emptyResult(e){return{value:e,done:!0}}function primeQueues(){var{pr:e,next:n}=getDeferred();r.push(e),i.push(n)}function onIOxUpdate(e,n){if(n===CLOSED)0==r.length&&doReturn();else if(!o){0==i.length&&primeQueues(),i.shift()({value:n,done:!1})}}function doNext(){if(o)return Promise.resolve(emptyResult());if(e.isClosed()&&0==r.length)return doReturn();0==r.length&&primeQueues();var t=r.shift();return s||function subscribe(){if(!s&&registerHooks.has(e)){s=!0;let[t]=registerHooks.get(e);trampoline(t(onIOxUpdate,e,n))}}(),t}function doReturn(s){var c=emptyResult(s);if(!o){if(o=!0,function unsubscribe(){if(registerHooks.has(e)){let[,n]=registerHooks.get(e);n(onIOxUpdate)}}(),t=r.length>0?r[r.length-1]:void 0,i.length>0)for(let e of i)e(emptyResult());i=r=n=e=onIOxUpdate=primeQueues=doNext=doReturn=u=null}return t?t.then((()=>{try{return c}finally{t=c=null}})):Promise.resolve(c)}}function safeIORun(e,n){try{var t=e.run(n);if(isRunSignal(n))return isPromise(t)?t.then((e=>trampoline(e))):t;isPromise(t)&&t.catch(logUnhandledError)}catch(e){if(isRunSignal(n))throw e;Promise.reject(e).catch(logUnhandledError)}}function logUnhandledError(e){Either.Left.is(e)?console.log(e.fold(identity,EMPTY_FUNC)):isMonad(e)?console.log(e._inspect()):isFunction(e.toString)?console.log(e.toString()):console.log(e)}